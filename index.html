<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy (CSP) for enhanced security -->
    <meta http-equiv="Content-Security-Policy"  
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://unpkg.com https://www.gstatic.com https://cdn.jsdelivr.net; 
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com https://fonts.googleapis.com; 
                   font-src 'self' https://fonts.gstatic.com; 
                   img-src 'self' https: data: blob:;
                   connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://identitytoolkit.googleapis.com https://fcmtoken.googleapis.com https://api.waqi.info https://api.openweathermap.org https://api.openaq.org https://gibs.earthdata.nasa.gov https://www.google-analytics.com https://firebaseinstallations.googleapis.com;">

    <title>Air Quality Monitor - Live AQI & Pollution Map by Ahmed Salem</title>
    <meta name="description" content="Track real-time air quality and pollution levels anywhere in the world. Get live AQI data, weather updates, and health recommendations with our interactive map, developed by Ahmed Salem.">
    <meta name="keywords" content="air quality, aqi, pollution, live map, air quality index, weather, real-time data, ahmed salem, web developer, portfolio">
    <meta name="author" content="Ahmed Salem">
    <link rel="canonical" href="https://air-quality-monitor-3.netlify.app" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png">
    
    <!-- Tailwind CSS, Google Fonts, LeafletJS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        :root { --font-primary: 'Inter', sans-serif; --font-secondary: 'Cairo', sans-serif; }
        body { background-color: #f8fafc; color: #1f2937; scroll-behavior: smooth; overflow-x: hidden; transition: background-color 0.3s, color 0.3s; }
        .lang-en { font-family: var(--font-primary); }
        .lang-ar { font-family: var(--font-secondary); }
        #map-container { height: 100vh; width: 100vw; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3b82f6; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hero-bg { background-color: #111827; background-image: radial-gradient(circle at 1px 1px, #4b5563 1px, transparent 0); background-size: 25px 25px; }
        .leaflet-control-geocoder-form input { font-family: var(--font-primary); }
        html[lang="ar"] .leaflet-control-geocoder-form input { font-family: var(--font-secondary); }
        #history-list li { cursor: pointer; transition: background-color: 0.2s; }
        #history-list li:hover { background-color: #f3f4f6; }
        
        .leaflet-control-container .leaflet-top {
            top: 80px; 
        }
        /* Responsive adjustments for header */
        @media (max-width: 640px) {
            .leaflet-control-container .leaflet-top {
                top: 130px; /* More space for wrapped header */
            }
        }
        
        /* --- Dark Mode Styles --- */
        .dark body { background-color: #000000; color: #e8e8e8; }
        .dark .bg-white { background-color: #121212; }
        .dark .bg-gray-50 { background-color: #000000; }
        .dark .text-gray-800 { color: #ffffff; }
        .dark .text-gray-600 { color: #a0a0a0; }
        .dark .text-gray-700 { color: #e8e8e8; }
        .dark .text-gray-500 { color: #888888; }
        .dark .border, .dark .border-b { border-color: #333333; }
        .dark .shadow-xl, .dark .shadow-lg, .dark .shadow-md { box-shadow: 0 10px 15px -3px rgba(0,0,0,.5), 0 4px 6px -2px rgba(0,0,0,.4); }
        .dark .hero-bg { background-color: #000000; background-image: radial-gradient(circle at 1px 1px, #444 1px, transparent 0); background-size: 25px 25px; }
        .dark #history-list li:hover { background-color: #2a2a2a; }
        .dark .leaflet-control-geocoder a, .dark .leaflet-control-zoom a, .dark #locate-btn { background-color: #121212; color: #ffffff; border: 1px solid #333333; }
        .dark .leaflet-control-geocoder, .dark .leaflet-control-zoom { border: 1px solid #333333; }
        .dark .leaflet-control-geocoder-form input { background-color: #2a2a2a; color: #ffffff; }
        .dark #data-panel { background-color: rgba(18, 18, 18, 0.9); }
        .dark .bg-gray-100 { background-color: #2a2a2a; }
        .dark .hover\:bg-gray-100:hover { background-color: #2a2a2a !important; }
        .dark .leaflet-tile-pane { filter: invert(1) hue-rotate(180deg) brightness(0.95) contrast(0.9); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Auth Modals -->
    <div id="auth-modals">
        <!-- Login Modal -->
        <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 relative">
                <button id="close-login-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="loginTitle">Login to Your Account</h3>
                <form id="login-form">
                    <input id="login-email" type="email" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Email" data-lang-key="emailPlaceholder">
                    <input id="login-password" type="password" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Password" data-lang-key="passwordPlaceholder">
                    <div class="text-right mb-4">
                        <a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline" data-lang-key="forgotPasswordLink">Forgot Password?</a>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700" data-lang-key="loginButton">Login</button>
                </form>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                <p class="text-center mt-4">
                    <span data-lang-key="noAccount">Don't have an account?</span>
                    <a href="#" id="show-signup" class="text-blue-600 hover:underline" data-lang-key="signupLink">Sign up</a>
                </p>
            </div>
        </div>
        <!-- Signup Modal -->
        <div id="signup-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 relative">
                 <button id="close-signup-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="signupTitle">Create a New Account</h3>
                <form id="signup-form">
                    <input id="signup-name" type="text" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Full Name" data-lang-key="namePlaceholder">
                    <input id="signup-email" type="email" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Email" data-lang-key="emailPlaceholder">
                    <input id="signup-password" type="password" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="New Password (min. 6 characters)" data-lang-key="newPasswordPlaceholder">
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700" data-lang-key="signupButton">Sign Up</button>
                </form>
                <p id="signup-error" class="text-red-500 text-sm mt-4 text-center"></p>
                <p class="text-center mt-4">
                    <span data-lang-key="hasAccount">Already have an account?</span>
                    <a href="#" id="show-login" class="text-blue-600 hover:underline" data-lang-key="loginLink">Login</a>
                </p>
            </div>
        </div>
        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 relative">
                 <button id="close-forgot-password-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="forgotPasswordTitle">Reset Password</h3>
                <form id="forgot-password-form">
                    <p class="text-center text-gray-600 mb-4" data-lang-key="forgotPasswordInstructions">Enter your email and we'll send you a link to reset your password.</p>
                    <input id="forgot-email" type="email" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Email" data-lang-key="emailPlaceholder">
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700" data-lang-key="sendResetLinkButton">Send Reset Link</button>
                </form>
                <p id="forgot-password-feedback" class="text-sm mt-4 text-center"></p>
            </div>
        </div>
        <!-- Change Password Modal -->
        <div id="password-change-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
             <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 relative">
                <button id="close-password-change-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="changePasswordTitle">Change Password</h3>
                <form id="password-change-form">
                    <input id="current-password" type="password" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Current Password" data-lang-key="currentPasswordPlaceholder" autocomplete="current-password">
                    <input id="new-password" type="password" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="New Password (min. 6 characters)" data-lang-key="newPasswordPlaceholder" autocomplete="new-password">
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700" data-lang-key="changePasswordButton">Update Password</button>
                </form>
                <p id="password-change-feedback" class="text-sm mt-4 text-center"></p>
            </div>
        </div>
        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
             <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4 relative">
                <button id="close-edit-profile-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="editProfileTitle">Edit Profile</h3>
                <form id="edit-profile-form">
                    <input id="edit-name" type="text" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Full Name" data-lang-key="namePlaceholder">
                    <hr class="my-4">
                    <p class="text-sm text-gray-500 mb-2" data-lang-key="editEmailInstructions">To change your email, please enter your current password.</p>
                    <input id="edit-email" type="email" class="w-full p-3 mb-4 border rounded bg-transparent" required placeholder="Email" data-lang-key="emailPlaceholder">
                    <input id="edit-password-verify" type="password" class="w-full p-3 mb-4 border rounded bg-transparent" placeholder="Current Password for verification" data-lang-key="currentPasswordPlaceholder">
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700 flex justify-center items-center" data-lang-key="saveChangesButton">Save Changes</button>
                </form>
                <p id="edit-profile-feedback" class="text-sm mt-4 text-center"></p>
            </div>
        </div>
        <!-- History Modal -->
        <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center hidden">
             <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4 relative">
                <button id="close-history-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h3 class="text-2xl font-bold mb-6 text-center" data-lang-key="historyTitle">Search History</h3>
                <div id="history-list-container" class="max-h-96 overflow-y-auto">
                    <ul id="history-list" class="space-y-2">
                        <!-- History items will be injected here -->
                    </ul>
                    <p id="no-history-message" class="text-center text-gray-500 hidden" data-lang-key="noHistory">Your search history is empty.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <header class="bg-gray-900/80 backdrop-blur-sm fixed top-0 left-0 right-0 z-20">
            <!-- Responsive Header -->
            <nav class="container mx-auto px-4 py-4 flex flex-wrap justify-between items-center">
                <a href="#" id="home-logo-link" class="flex items-center space-x-2">
                     <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjk7K0IOVXn7WvuM8wl4rXWpCAvvMG8mUjenuSlZsBh6iUeoH8SlHd-dzzCdnIoSxHr6atY7R8fQKji1gIeZ282QhKL-QbXSEUaayoYuxFdtWtogbLhcBOwBAKWuKcolUYEzDxDd8xkgjP-ZSIsIS1DsSx_50DhHDoUp8LVN1hDsy-jHCJxn4vbPnoKnYE/s1260/favicon.png" alt="Logo" class="h-8 w-8">
                     <h1 class="text-lg sm:text-xl font-bold text-white" data-lang-key="appName">Air Quality Monitor</h1>
                </a>
                <div class="flex items-center space-x-2 sm:space-x-4 mt-4 sm:mt-0 w-full sm:w-auto justify-center sm:justify-end">
                    <!-- Language Switcher -->
                    <div class="flex space-x-2">
                        <button id="lang-en" class="text-white font-semibold text-sm py-1 px-2 rounded bg-gray-700">EN</button>
                        <button id="lang-ar" class="text-gray-400 font-semibold text-sm py-1 px-2 rounded hover:bg-gray-700">AR</button>
                    </div>

                    <!-- Theme Switcher -->
                    <button id="theme-toggle" class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 15a5 5 0 100-10 5 5 0 000 10zM10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm0 14a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-7-8a1 1 0 011-1h1a1 1 0 110 2H4a1 1 0 01-1-1zm14 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1zm-2.929-5.071a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707zm-9.142 9.142a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414l.707.707zm9.142 0a1 1 0 01-1.414 1.414l.707.707a1 1 0 011.414-1.414l-.707-.707zm-9.142-9.142a1 1 0 01-1.414 1.414l.707.707a1 1 0 011.414-1.414l-.707-.707z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    </button>

                    <!-- Read Aloud Button -->
                    <button id="read-aloud-btn" class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500" title="Read page content aloud">
                        <svg id="read-aloud-play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 5.14v14l11-7-11-7z"></path></svg>
                        <svg id="read-aloud-stop-icon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M6 6h12v12H6z"></path></svg>
                    </button>

                    <!-- Auth Buttons / User Menu -->
                    <div id="auth-container-logged-out" class="flex space-x-2">
                        <button id="login-btn" class="bg-gray-700 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-600 text-sm" data-lang-key="navLogin">Login</button>
                        <button id="signup-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg font-semibold hover:bg-blue-700 text-sm" data-lang-key="navSignup">Sign Up</button>
                    </div>
                    <div id="auth-container-logged-in" class="hidden relative">
                        <button id="user-menu-btn" class="bg-gray-700 text-white px-3 py-2 rounded-lg font-semibold hover:bg-gray-600 text-sm flex items-center">
                            <span id="user-name-display" class="truncate max-w-[100px] sm:max-w-xs"></span>
                            <svg class="w-4 h-4 ml-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="user-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-30 hidden">
                            <a href="#" id="edit-profile-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang-key="menuEditProfile">Edit Profile</a>
                            <a href="#" id="history-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang-key="menuHistory">Search History</a>
                            <a href="#" id="change-password-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang-key="menuChangePassword">Change Password</a>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang-key="menuLogout">Logout</a>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Landing Page Section -->
        <div id="landing-page">
             <!-- Added padding-top to account for the taller header -->
            <section class="hero-bg text-white pt-48 sm:pt-32 pb-20 text-center">
                <div class="container mx-auto px-4">
                    <h2 class="text-3xl sm:text-4xl md:text-6xl font-extrabold mb-4 leading-tight" data-lang-key="heroTitle">Breathe Clearer. Live Better.</h2>
                    <p class="text-base sm:text-lg md:text-xl text-gray-300 mb-8 max-w-3xl mx-auto" data-lang-key="heroSubtitle">Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.</p>
                    <a href="#map" id="launch-map-btn" class="bg-blue-600 text-white text-lg px-8 py-4 rounded-lg font-bold hover:bg-blue-700 transition-transform transform hover:scale-105 inline-block" data-lang-key="heroButton">Launch Live Map</a>
                </div>
            </section>
            
            <!-- NEW Detailed Features Section -->
            <section id="about-features" class="py-20 bg-white">
                <div class="container mx-auto px-4">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl md:text-4xl font-bold" data-lang-key="aboutTitle">A Comprehensive Tool for Your Well-being</h2>
                        <p class="text-gray-600 mt-4 max-w-3xl mx-auto" data-lang-key="aboutSubtitle">We combine air quality, weather data, and personalized features to give you a complete picture of your environment.</p>
                    </div>
            
                    <div class="space-y-16">
                        <!-- Feature 1: Interactive Map -->
                        <div class="flex flex-wrap items-center">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pr-8">
                                <div class="p-3 text-blue-600 bg-blue-100 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3" data-lang-key="feature1Title">Live Interactive Map</h3>
                                <p class="text-gray-600" data-lang-key="feature1Desc">Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12 mt-8 md:mt-0">
                                <img src="https://images.unsplash.com/photo-1593642702821-c8da6771f0c6?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Laptop with map" class="rounded-lg shadow-xl">
                            </div>
                        </div>

                        <!-- Feature 2: Detailed Data Panel -->
                         <div class="flex flex-wrap items-center flex-col-reverse md:flex-row-reverse">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pl-8 mt-8 md:mt-0">
                                <div class="p-3 text-green-600 bg-green-100 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3" data-lang-key="feature2Title">Detailed Data & Weather</h3>
                                <p class="text-gray-600" data-lang-key="feature2Desc">Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12">
                                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEik6YyOCHbuvpICg9Ps2SQIUJVYrTNaB1aPbVILr79xK87h5qLCL-9zyAuQvzrVPVZQcc0s9v2OGyhp1cMJx1jfQ8HkKE0M_1DtACaCud51rj-FNBhhmLxZQedEOX-hkEnI_87XOKSnRWclh5lFcw3OH-pnioaE5vp973_JIi3Cyuhru5FwUhyZE-E8gT8" alt="Weather dashboard" class="rounded-lg shadow-xl">
                            </div>
                        </div>
                        
                        <!-- Feature 3: Search -->
                        <div class="flex flex-wrap items-center">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pr-8">
                                <div class="p-3 text-purple-600 bg-purple-100 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3" data-lang-key="feature3Title">Accurate Global Search</h3>
                                <p class="text-gray-600" data-lang-key="feature3Desc">Can't find a place by clicking? Use our powerful search bar. Just type the name of any city or region, in English or Arabic, and the map will instantly take you there, providing the data you need.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12 mt-8 md:mt-0">
                                <img src="https://images.unsplash.com/photo-1516321497487-e288fb19713f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Person searching on a map" class="rounded-lg shadow-xl">
                            </div>
                        </div>
                        
                        <!-- Feature 4: Health Advice -->
                         <div class="flex flex-wrap items-center flex-col-reverse md:flex-row-reverse">
                            <div class="w-full md:w-1/2 lg:w-5/12 px-4 md:pl-8 mt-8 md:mt-0">
                                <div class="p-3 text-red-600 bg-red-100 rounded-full inline-block mb-4">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                </div>
                                <h3 class="text-2xl font-bold mb-3" data-lang-key="feature4Title">Personalized Health Advice</h3>
                                <p class="text-gray-600" data-lang-key="feature4Desc">Based on the AQI level, we provide clear and simple health recommendations. Know when it's safe to exercise outdoors and when it's better for you and your family to stay inside.</p>
                            </div>
                            <div class="w-full md:w-1/2 lg:w-7/12">
                                <img src="https://images.unsplash.com/photo-1556740758-90de374c12ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Person checking phone for health info" class="rounded-lg shadow-xl">
                            </div>
                        </div>
                    </div>
                </div>
            </section>


            <!-- Advanced Features Section -->
            <section id="advanced-features" class="bg-gray-50 py-20">
                <div class="container mx-auto px-4 text-center">
                      <div>
                         <h3 class="text-3xl font-bold mb-2" data-lang-key="advFeaturesTitle">Advanced Account Features</h3>
                         <p class="text-gray-600 mb-12" data-lang-key="advFeaturesSubtitle">Get more out of the monitor with a free account.</p>
                       </div>
                       <div class="grid md:grid-cols-3 gap-8">
                           <div class="p-6 bg-white rounded-lg shadow-md">
                                <svg class="w-12 h-12 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                 <h4 class="text-xl font-bold mb-2" data-lang-key="advFeature1Title">Secure Accounts</h4>
                                 <p class="text-gray-600" data-lang-key="advFeature1Desc">Create a free and secure account to manage your experience. Your data is protected using industry-standard security practices.</p>
                           </div>
                           <div class="p-6 bg-white rounded-lg shadow-md">
                                <svg class="w-12 h-12 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                 <h4 class="text-xl font-bold mb-2" data-lang-key="advFeature2Title">Cloud History</h4>
                                 <p class="text-gray-600" data-lang-key="advFeature2Desc">Your search history is automatically saved to your account, allowing you to access your frequent locations from any device.</p>
                           </div>
                           <div class="p-6 bg-white rounded-lg shadow-md">
                                <svg class="w-12 h-12 text-blue-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                 <h4 class="text-xl font-bold mb-2" data-lang-key="advFeature3Title">Account Management</h4>
                                 <p class="text-gray-600" data-lang-key="advFeature3Desc">Easily manage your account settings, including the ability to change your password at any time to keep your account secure.</p>
                           </div>
                       </div>
                </div>
            </section>
            
        </div>

        <!-- Map & App Section (Initially Hidden) -->
        <div id="map-view" class="hidden">
             <div id="map-container" class="relative">
                <div id="map"></div>
                <!-- Data Panel and other map overlays will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-black py-6 text-center text-gray-600 dark:text-gray-400 border-t border-gray-200 dark:border-gray-800">
        <div class="container mx-auto px-4">
            <p data-lang-key="footerText">&copy; 2024 All rights reserved for Digital Minds team</p>
        </div>
    </footer>

    <!-- Main App Script -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            updatePassword,
            EmailAuthProvider,
            reauthenticateWithCredential,
            sendPasswordResetEmail,
            updateProfile,
            updateEmail
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            doc,
            setDoc, 
            query, 
            orderBy, 
            limit, 
            getDocs, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- TRANSLATIONS OBJECT ---
        const translations = {
            en: {
                appName: "Air Quality Monitor",
                navLogin: "Login",
                navSignup: "Sign Up",
                heroTitle: "Breathe Clearer. Live Better.",
                heroSubtitle: "Your real-time guide to the air you breathe. We provide live, accurate air quality data to help you make healthier decisions every day.",
                heroButton: "Launch Live Map",
                namePlaceholder: "Full Name",
                emailPlaceholder: "Email",
                passwordPlaceholder: "Password",
                loginTitle: "Login to Your Account",
                loginButton: "Login",
                noAccount: "Don't have an account?",
                signupLink: "Sign up",
                signupTitle: "Create a New Account",
                signupButton: "Sign Up",
                hasAccount: "Already have an account?",
                loginLink: "Login",
                forgotPasswordLink: "Forgot Password?",
                forgotPasswordTitle: "Reset Password",
                forgotPasswordInstructions: "Enter your email and we'll send you a link to reset your password.",
                sendResetLinkButton: "Send Reset Link",
                resetEmailSent: "Password reset email sent! Please check your inbox and spam folder.",
                changePasswordTitle: "Change Password",
                currentPasswordPlaceholder: "Current Password for verification",
                newPasswordPlaceholder: "New Password (min. 6 characters)",
                changePasswordButton: "Update Password",
                passwordUpdateSuccess: "Password updated successfully!",
                passwordUpdateError: "Incorrect current password. Please try again.",
                menuEditProfile: "Edit Profile",
                editProfileTitle: "Edit Profile",
                editEmailInstructions: "To change your email, please enter your current password.",
                saveChangesButton: "Save Changes",
                profileUpdateSuccess: "Profile updated successfully!",
                menuHistory: "Search History",
                menuChangePassword: "Change Password",
                menuLogout: "Logout",
                searchPlaceholder: "Search for a city or place...",
                historyTitle: "Search History",
                noHistory: "Your search history is empty.",
                aboutTitle: "A Comprehensive Tool for Your Well-being",
                aboutSubtitle: "We combine air quality, weather data, and personalized features to give you a complete picture of your environment.",
                feature1Title: "Live Interactive Map",
                feature1Desc: "Our core feature is a dynamic world map. Click anywhere to get instant, real-time Air Quality Index (AQI) data from the nearest monitoring station. Track pollution levels in your city or anywhere you plan to travel.",
                feature2Title: "Detailed Data & Weather",
                feature2Desc: "Beyond the AQI number, our detailed panel shows you crucial weather information like temperature, humidity, and wind speed. This helps you understand how weather conditions affect air quality.",
                feature3Title: "Accurate Global Search",
                feature3Desc: "Can't find a place by clicking? Use our powerful search bar. Just type the name of any city or region, in English or Arabic, and the map will instantly take you there, providing the data you need.",
                feature4Title: "Personalized Health Advice",
                feature4Desc: "Based on the AQI level, we provide clear and simple health recommendations. Know when it's safe to exercise outdoors and when it's better for you and your family to stay inside.",
                advFeaturesTitle: "Advanced Account Features",
                advFeaturesSubtitle: "Get more out of the monitor with a free account.",
                advFeature1Title: "Secure Accounts",
                advFeature1Desc: "Create a free and secure account to manage your experience. Your data is protected using industry-standard security practices.",
                advFeature2Title: "Cloud History",
                advFeature2Desc: "Your search history is automatically saved to your account, allowing you to access your frequent locations from any device.",
                advFeature3Title: "Account Management",
                advFeature3Desc: "Easily manage your account settings, including the ability to change your password at any time to keep your account secure.",
                dataPanelAQI: "Air Quality Index (AQI)",
                dataPanelTemp: "Temp",
                dataPanelHumidity: "Humidity",
                dataPanelWind: "Wind",
                dataPanelHealthAdvice: "Health Advice:",
                footerText: "© 2024 All rights reserved for Digital Minds team",
                // AQI Statuses and Advice
                aqiStatusGood: "Good",
                aqiAdviceGood: "Air quality is excellent. Great day to be active outside!",
                aqiStatusModerate: "Moderate",
                aqiAdviceModerate: "Air quality is acceptable. Sensitive individuals may have symptoms.",
                aqiStatusUnhealthySensitive: "Unhealthy for Sensitive",
                aqiAdviceUnhealthySensitive: "Sensitive groups should reduce heavy exertion outdoors.",
                aqiStatusUnhealthy: "Unhealthy",
                aqiAdviceUnhealthy: "Everyone should reduce heavy exertion outdoors.",
                aqiStatusVeryUnhealthy: "Very Unhealthy",
                aqiAdviceVeryUnhealthy: "Health alert: Avoid all outdoor physical activity.",
                aqiStatusHazardous: "Hazardous",
                aqiAdviceHazardous: "Health warning: Everyone should stay indoors.",
                aqiStatusNoData: "No Data",
                aqiError: "AQI data not available for this location.",
                fetchError: "Failed to fetch all data. Please try again.",
                errorTitle: "Error"
            },
            ar: {
                appName: "مراقب جودة الهواء",
                navLogin: "تسجيل الدخول",
                navSignup: "حساب جديد",
                heroTitle: "تنفس أنقى. عش أفضل.",
                heroSubtitle: "دليلك الفوري لجودة الهواء الذي تتنفسه. نحن نقدم بيانات دقيقة ومباشرة لمساعدتك على اتخاذ قرارات صحية كل يوم.",
                heroButton: "افتح الخريطة المباشرة",
                namePlaceholder: "الاسم الكامل",
                emailPlaceholder: "البريد الإلكتروني",
                passwordPlaceholder: "كلمة المرور",
                loginTitle: "تسجيل الدخول إلى حسابك",
                loginButton: "دخول",
                noAccount: "ليس لديك حساب؟",
                signupLink: "أنشئ حسابًا",
                signupTitle: "إنشاء حساب جديد",
                signupButton: "إنشاء حساب",
                hasAccount: "هل لديك حساب بالفعل؟",
                loginLink: "تسجيل الدخول",
                forgotPasswordLink: "هل نسيت كلمة المرور؟",
                forgotPasswordTitle: "إعادة تعيين كلمة المرور",
                forgotPasswordInstructions: "أدخل بريدك الإلكتروني وسنرسل لك رابطًا لإعادة تعيين كلمة المرور.",
                sendResetLinkButton: "أرسل رابط الاستعادة",
                resetEmailSent: "تم إرسال بريد إعادة تعيين كلمة المرور! يرجى التحقق من بريدك الوارد ومجلد الرسائل غير المرغوب فيها (Spam).",
                changePasswordTitle: "تغيير كلمة المرور",
                currentPasswordPlaceholder: "كلمة المرور الحالية للتحقق",
                newPasswordPlaceholder: "كلمة المرور الجديدة (6 أحرف على الأقل)",
                changePasswordButton: "تحديث كلمة المرور",
                passwordUpdateSuccess: "تم تحديث كلمة المرور بنجاح!",
                passwordUpdateError: "كلمة المرور الحالية غير صحيحة. يرجى المحاولة مرة أخرى.",
                menuEditProfile: "تعديل الملف الشخصي",
                editProfileTitle: "تعديل الملف الشخصي",
                saveChangesButton: "حفظ التغييرات",
                profileUpdateSuccess: "تم تحديث الملف الشخصي بنجاح!",
                menuHistory: "سجل البحث",
                menuChangePassword: "تغيير كلمة المرور",
                menuLogout: "تسجيل الخروج",
                searchPlaceholder: "ابحث عن مدينة أو مكان...",
                historyTitle: "سجل البحث",
                noHistory: "سجل البحث الخاص بك فارغ.",
                aboutTitle: "أداة شاملة لرفاهيتك",
                aboutSubtitle: "نحن نجمع بين بيانات جودة الهواء والطقس والميزات المخصصة لنمنحك صورة كاملة عن بيئتك.",
                feature1Title: "خريطة تفاعلية مباشرة",
                feature1Desc: "ميزتنا الأساسية هي خريطة عالمية ديناميكية. انقر في أي مكان للحصول على بيانات مؤشر جودة الهواء (AQI) الفورية في الوقت الفعلي من أقرب محطة مراقبة. تتبع مستويات التلوث في مدينتك أو أي مكان تخطط للسفر إليه.",
                feature2Title: "بيانات مفصلة والطقس",
                feature2Desc: "إلى جانب رقم مؤشر جودة الهواء، تعرض لك لوحة البيانات التفصيلية معلومات الطقس الهامة مثل درجة الحرارة والرطوبة وسرعة الرياح. يساعدك هذا على فهم كيفية تأثير الظروف الجوية على جودة الهواء.",
                feature3Title: "بحث عالمي دقيق",
                feature3Desc: "لا يمكنك العثور على مكان بالنقر؟ استخدم شريط البحث القوي الخاص بنا. فقط اكتب اسم أي مدينة أو منطقة، باللغة الإنجليزية أو العربية، وستأخذك الخريطة على الفور إلى هناك، مع توفير البيانات التي تحتاجها.",
                feature4Title: "نصائح صحية مخصصة",
                feature4Desc: "بناءً على مستوى مؤشر جودة الهواء، نقدم توصيات صحية واضحة وبسيطة. اعرف متى يكون من الآمن ممارسة الرياضة في الهواء الطلق ومتى يكون من الأفضل لك ولعائلتك البقاء في الداخل.",
                advFeaturesTitle: "ميزات متقدمة لحسابك",
                advFeaturesSubtitle: "احصل على المزيد من الميزات عند إنشاء حساب مجاني.",
                advFeature1Title: "حسابات آمنة",
                advFeature1Desc: "أنشئ حسابًا مجانيًا وآمنًا لإدارة تجربتك. بياناتك محمية باستخدام أفضل معايير الأمان.",
                advFeature2Title: "سجل سحابي",
                advFeature2Desc: "يتم حفظ سجل البحث تلقائيًا في حسابك، مما يتيح لك الوصول إلى أماكنك المتكررة من أي جهاز.",
                advFeature3Title: "إدارة الحساب",
                advFeature3Desc: "يمكنك إدارة إعدادات حسابك بسهولة، بما في ذلك القدرة على تغيير كلمة المرور في أي وقت للحفاظ على أمان حسابك.",
                dataPanelAQI: "مؤشر جودة الهواء (AQI)",
                dataPanelTemp: "الحرارة",
                dataPanelHumidity: "الرطوبة",
                dataPanelWind: "الرياح",
                dataPanelHealthAdvice: "نصيحة صحية:",
                footerText: "© 2024 جميع الحقوق محفوظة لفريق Digital Minds",
                 // AQI Statuses and Advice
                aqiStatusGood: "جيد",
                aqiAdviceGood: "جودة الهواء ممتازة. يوم رائع للنشاط في الخارج!",
                aqiStatusModerate: "متوسط",
                aqiAdviceModerate: "جودة الهواء مقبولة. قد يعاني الأفراد الحساسون من أعراض.",
                aqiStatusUnhealthySensitive: "غير صحي للحساسين",
                aqiAdviceUnhealthySensitive: "يجب على المجموعات الحساسة تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusUnhealthy: "غير صحي",
                aqiAdviceUnhealthy: "يجب على الجميع تقليل المجهود الشاق في الهواء الطلق.",
                aqiStatusVeryUnhealthy: "غير صحي للغاية",
                aqiAdviceVeryUnhealthy: "تنبيه صحي: تجنب كل الأنشطة البدنية في الهواء الطلق.",
                aqiStatusHazardous: "خطير",
                aqiAdviceHazardous: "تحذير صحي: يجب على الجميع البقاء في الداخل.",
                aqiStatusNoData: "لا توجد بيانات",
                aqiError: "بيانات جودة الهواء غير متوفرة لهذا الموقع.",
                fetchError: "فشل جلب جميع البيانات. يرجى المحاولة مرة أخرى.",
                errorTitle: "خطأ"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE CONFIGURATION ---
            const firebaseConfig = {
                apiKey: "AIzaSyBuyUNk6-0OglHwO_N7Ar2V7IR_WjAH41M",
                authDomain: "air-quality-monitor-6717a.firebaseapp.com",
                projectId: "air-quality-monitor-6717a",
                storageBucket: "air-quality-monitor-6717a.appspot.com",
                messagingSenderId: "864803225125",
                appId: "1:864803225125:web:b058d248c460be218749cc",
                measurementId: "G-KQFHV5T3VX"
            };
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // --- UI ELEMENTS ---
            const landingPage = document.getElementById('landing-page');
            const mapView = document.getElementById('map-view');
            const mapContainer = document.getElementById('map-container');
            const langEnBtn = document.getElementById('lang-en');
            const langArBtn = document.getElementById('lang-ar');
            const loggedOutContainer = document.getElementById('auth-container-logged-out');
            const loggedInContainer = document.getElementById('auth-container-logged-in');
            const userNameDisplay = document.getElementById('user-name-display');
            const userMenuBtn = document.getElementById('user-menu-btn');
            const userMenu = document.getElementById('user-menu');
            const loginModal = document.getElementById('login-modal');
            const signupModal = document.getElementById('signup-modal');
            const passwordChangeModal = document.getElementById('password-change-modal');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const editProfileModal = document.getElementById('edit-profile-modal');
            const historyModal = document.getElementById('history-modal');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const passwordChangeForm = document.getElementById('password-change-form');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const editProfileForm = document.getElementById('edit-profile-form');
            const historyList = document.getElementById('history-list');
            const noHistoryMessage = document.getElementById('no-history-message');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
            const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
            const readAloudBtn = document.getElementById('read-aloud-btn');
            const readAloudPlayIcon = document.getElementById('read-aloud-play-icon');
            const readAloudStopIcon = document.getElementById('read-aloud-stop-icon');

            let mapInitialized = false;
            let map = null;
            let speechVoices = [];

            // --- TEXT-TO-SPEECH VOICE LOADER ---
            function loadVoices() {
                speechVoices = speechSynthesis.getVoices();
            }
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            
            // --- THEME/DARK MODE LOGIC ---
            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeToggleLightIcon.classList.add('hidden');
                    themeToggleDarkIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    themeToggleDarkIcon.classList.add('hidden');
                    themeToggleLightIcon.classList.remove('hidden');
                }
            };

            const toggleTheme = () => {
                const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            };

            themeToggleBtn.addEventListener('click', toggleTheme);

            // Set initial theme on page load
            const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(initialTheme);
            
            // --- SECURITY HELPER ---
            const sanitizeInput = (input) => {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            };

            // --- LANGUAGE SWITCHER LOGIC ---
            const setLanguage = (lang) => {
                speechSynthesis.cancel();
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                
                // Keep dark mode class if it exists
                const bodyClasses = ['lang-' + lang, 'text-gray-800'];
                if(document.documentElement.classList.contains('dark')) {
                    bodyClasses.push('dark');
                }
                document.body.className = bodyClasses.join(' ');

                document.querySelectorAll('[data-lang-key]').forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    const translation = translations[lang][key];
                    if (translation) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.setAttribute('placeholder', translation);
                        } else {
                            element.textContent = translation;
                        }
                    }
                });
                
                if (map) {
                    const geocoderControl = document.querySelector('.leaflet-control-geocoder-form input');
                    if (geocoderControl) {
                        geocoderControl.placeholder = translations[lang].searchPlaceholder;
                    }
                }

                localStorage.setItem('preferredLanguage', lang);
                updateLangButtons(lang);
            };

            const updateLangButtons = (lang) => {
                if (lang === 'ar') {
                    langArBtn.classList.add('bg-gray-700', 'text-white');
                    langArBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                    langEnBtn.classList.remove('bg-gray-700', 'text-white');
                    langEnBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                } else {
                    langEnBtn.classList.add('bg-gray-700', 'text-white');
                    langEnBtn.classList.remove('text-gray-400', 'hover:bg-gray-700');
                    langArBtn.classList.remove('bg-gray-700', 'text-white');
                    langArBtn.classList.add('text-gray-400', 'hover:bg-gray-700');
                }
            };
            
            langEnBtn.addEventListener('click', () => setLanguage('en'));
            langArBtn.addEventListener('click', () => setLanguage('ar'));
            
            const preferredLanguage = localStorage.getItem('preferredLanguage') || 'en';
            setLanguage(preferredLanguage);


            // --- VIEW MANAGEMENT ---
            const showLandingPage = () => {
                speechSynthesis.cancel();
                landingPage.classList.remove('hidden');
                mapView.classList.add('hidden');
                if (window.location.hash === "#map") {
                    window.location.hash = "";
                }
            };

            const showMapView = () => {
                speechSynthesis.cancel();
                landingPage.classList.add('hidden');
                mapView.classList.remove('hidden');
                if (!mapInitialized) {
                    initializeMapApp();
                    mapInitialized = true;
                }
                setTimeout(() => { if (map) map.invalidateSize(); }, 0);
            };
            
             // --- TEXT-TO-SPEECH LOGIC ---
            const handleReadAloud = () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    return;
                }

                let textToRead = '';
                const isMapView = !mapView.classList.contains('hidden');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                if (isMapView) {
                    const dataPanel = document.getElementById('data-panel');
                    const dataContent = document.getElementById('data-content');
                    if (dataPanel && !dataPanel.classList.contains('hidden') && dataContent && !dataContent.classList.contains('hidden')) {
                        const city = document.getElementById('city-name').innerText;
                        const aqiLabel = translations[currentLang].dataPanelAQI;
                        const aqiValue = document.getElementById('aqi-value').innerText;
                        const aqiStatus = document.getElementById('aqi-status').innerText;
                        const adviceLabel = translations[currentLang].dataPanelHealthAdvice;
                        const advice = document.getElementById('forecast-text').innerText;
                        textToRead = `${city}. ${aqiLabel}: ${aqiValue}, ${aqiStatus}. ${adviceLabel}: ${advice}`;
                    } else {
                        textToRead = currentLang === 'ar' ? 'الرجاء تحديد موقع على الخريطة أولاً.' : 'Please select a location on the map first.';
                    }
                } else {
                    textToRead = landingPage.innerText.replace(/\s\s+/g, ' ').trim();
                }

                if (!textToRead.trim()) { return; }

                const utterance = new SpeechSynthesisUtterance(textToRead);
                const langCode = currentLang === 'ar' ? 'ar-SA' : 'en-US';
                const langShortCode = currentLang === 'ar' ? 'ar' : 'en';

                let selectedVoice = speechVoices.find(voice => voice.lang === langCode);
                if (!selectedVoice) {
                    selectedVoice = speechVoices.find(voice => voice.lang.startsWith(langShortCode));
                }

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                } else {
                    utterance.lang = langCode;
                    console.warn(`TTS voice for '${langCode}' not found. Falling back to browser default.`);
                }
                
                utterance.onstart = () => {
                    readAloudPlayIcon.classList.add('hidden');
                    readAloudStopIcon.classList.remove('hidden');
                };
                utterance.onend = () => {
                    readAloudPlayIcon.classList.remove('hidden');
                    readAloudStopIcon.classList.add('hidden');
                };
                utterance.onerror = (event) => {
                    console.error('SpeechSynthesisUtterance.onerror', event);
                    readAloudPlayIcon.classList.remove('hidden');
                    readAloudStopIcon.classList.add('hidden');
                };
                
                speechSynthesis.speak(utterance);
            };
            readAloudBtn.addEventListener('click', handleReadAloud);


            // --- AUTHENTICATION STATE OBSERVER ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    loggedOutContainer.classList.add('hidden');
                    loggedInContainer.classList.remove('hidden');
                    userNameDisplay.textContent = user.displayName || user.email;
                    if(window.location.hash === '#map' && !mapInitialized) {
                       showMapView();
                    }
                } else {
                    loggedOutContainer.classList.remove('hidden');
                    loggedInContainer.classList.add('hidden');
                    userNameDisplay.textContent = '';
                    showLandingPage();
                }
            });
            
            document.getElementById('launch-map-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if (auth.currentUser) {
                    window.location.hash = '#map';
                } else {
                    loginModal.classList.remove('hidden');
                }
            });
            document.getElementById('home-logo-link').addEventListener('click', (e) => {
                e.preventDefault();
                showLandingPage();
            });
            
            window.addEventListener('hashchange', () => {
                 if(window.location.hash === '#map' && auth.currentUser) {
                    showMapView();
                 } else {
                    showLandingPage();
                 }
            });


            // --- MODAL AND FORM HANDLING ---
            document.getElementById('login-btn').addEventListener('click', () => loginModal.classList.remove('hidden'));
            document.getElementById('signup-btn').addEventListener('click', () => signupModal.classList.remove('hidden'));
            document.getElementById('change-password-btn').addEventListener('click', (e) => {
                e.preventDefault();
                userMenu.classList.add('hidden');
                passwordChangeModal.classList.remove('hidden');
            });
             document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                loginModal.classList.add('hidden');
                forgotPasswordModal.classList.remove('hidden');
            });
            document.getElementById('edit-profile-btn').addEventListener('click', (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (user) {
                    document.getElementById('edit-name').value = user.displayName || '';
                    document.getElementById('edit-email').value = user.email || '';
                }
                userMenu.classList.add('hidden');
                editProfileModal.classList.remove('hidden');
            });
            document.getElementById('history-btn').addEventListener('click', (e) => {
                e.preventDefault();
                userMenu.classList.add('hidden');
                displaySearchHistory();
                historyModal.classList.remove('hidden');
            });
            
            const closeAllModals = () => {
                document.querySelectorAll('#auth-modals > div').forEach(modal => modal.classList.add('hidden'));
                const feedbackElements = document.querySelectorAll('#login-error, #signup-error, #password-change-feedback, #forgot-password-feedback, #edit-profile-feedback');
                feedbackElements.forEach(el => el.textContent = '');
            };

            document.getElementById('close-login-modal').addEventListener('click', closeAllModals);
            document.getElementById('close-signup-modal').addEventListener('click', closeAllModals);
            document.getElementById('close-password-change-modal').addEventListener('click', closeAllModals);
            document.getElementById('close-forgot-password-modal').addEventListener('click', closeAllModals);
            document.getElementById('close-edit-profile-modal').addEventListener('click', closeAllModals);
            document.getElementById('close-history-modal').addEventListener('click', closeAllModals);
            
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); loginModal.classList.add('hidden'); signupModal.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); signupModal.classList.add('hidden'); loginModal.classList.remove('hidden'); });

            userMenuBtn.addEventListener('click', () => userMenu.classList.toggle('hidden'));
            document.addEventListener('click', (e) => {
                if (!loggedInContainer.contains(e.target)) {
                    userMenu.classList.add('hidden');
                }
            });

            // --- FIREBASE AUTH ACTIONS ---
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                
                const sanitizedName = sanitizeInput(name);
                if (name !== sanitizedName) {
                    document.getElementById('signup-error').textContent = "Invalid characters in name.";
                    return;
                }

                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        return updateProfile(userCredential.user, { displayName: sanitizedName });
                    })
                    .then(() => {
                        closeAllModals();
                        signupForm.reset();
                    })
                    .catch(error => { document.getElementById('signup-error').textContent = error.message; });
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                signInWithEmailAndPassword(auth, email, password)
                    .then(() => { closeAllModals(); loginForm.reset(); })
                    .catch(error => { document.getElementById('login-error').textContent = error.message; });
            });
            
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth);
            });

            passwordChangeForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const user = auth.currentUser;
                const feedbackEl = document.getElementById('password-change-feedback');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';

                if (!user) return;
                
                const credential = EmailAuthProvider.credential(user.email, currentPassword);

                reauthenticateWithCredential(user, credential).then(() => {
                    return updatePassword(user, newPassword);
                }).then(() => {
                    feedbackEl.textContent = translations[currentLang].passwordUpdateSuccess;
                    feedbackEl.className = "text-green-500 text-sm mt-4 text-center";
                    passwordChangeForm.reset();
                    setTimeout(() => { closeAllModals(); }, 2000);
                }).catch((error) => {
                    if (error.code === 'auth/wrong-password') {
                        feedbackEl.textContent = translations[currentLang].passwordUpdateError;
                    } else {
                        feedbackEl.textContent = error.message;
                    }
                    feedbackEl.className = "text-red-500 text-sm mt-4 text-center";
                });
            });

            forgotPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('forgot-email').value;
                const feedbackEl = document.getElementById('forgot-password-feedback');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        feedbackEl.textContent = translations[currentLang].resetEmailSent;
                        feedbackEl.className = "text-green-500 text-sm mt-4 text-center";
                        forgotPasswordForm.reset();
                         setTimeout(() => { closeAllModals(); }, 3000);
                    })
                    .catch((error) => {
                        feedbackEl.textContent = error.message;
                        feedbackEl.className = "text-red-500 text-sm mt-4 text-center";
                    });
            });

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = document.getElementById('edit-name').value;
                const newEmail = document.getElementById('edit-email').value;
                const password = document.getElementById('edit-password-verify').value;
                const user = auth.currentUser;
                const feedbackEl = document.getElementById('edit-profile-feedback');
                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                const submitBtn = editProfileForm.querySelector('button[type="submit"]');

                const sanitizedName = sanitizeInput(newName);
                if (newName !== sanitizedName) {
                    feedbackEl.textContent = "Invalid characters in name.";
                    feedbackEl.className = "text-red-500 text-sm mt-4 text-center";
                    return;
                }

                if (!user) return;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<div class="loader" style="border-top-color: white; width: 20px; height: 20px; margin: auto; border-width: 2px;"></div>`;

                try {
                    const nameChanged = sanitizedName !== user.displayName;
                    if (nameChanged) {
                        await updateProfile(user, { displayName: sanitizedName });
                    }

                    const emailChanged = newEmail !== user.email;
                    if (emailChanged) {
                        if (!password) throw new Error("Password is required to change email.");
                        const credential = EmailAuthProvider.credential(user.email, password);
                        await reauthenticateWithCredential(user, credential);
                        await updateEmail(user, newEmail);
                    }
                    
                    if (nameChanged || emailChanged) {
                        feedbackEl.textContent = translations[currentLang].profileUpdateSuccess;
                        feedbackEl.className = "text-green-500 text-sm mt-4 text-center";
                    }

                    setTimeout(() => { closeAllModals(); }, 2000);

                } catch (error) {
                     if (error.code === 'auth/wrong-password') {
                        feedbackEl.textContent = translations[currentLang].passwordUpdateError;
                    } else {
                        feedbackEl.textContent = error.message;
                    }
                    feedbackEl.className = "text-red-500 text-sm mt-4 text-center";
                } finally {
                     submitBtn.disabled = false;
                     submitBtn.textContent = translations[currentLang].saveChangesButton;
                }
            });


            // --- HISTORY LOGIC (FIRESTORE) ---
            const saveSearchToHistory = (locationData) => {
                const user = auth.currentUser;
                if (!user) return;
                
                const historyRef = collection(db, 'users', user.uid, 'history');
                addDoc(historyRef, {
                    name: locationData.name,
                    lat: locationData.lat,
                    lng: locationData.lng,
                    timestamp: serverTimestamp()
                }).catch(error => console.error("Error adding document: ", error));
            };

            const displaySearchHistory = async () => {
                const user = auth.currentUser;
                if (!user) return;

                historyList.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loader"></div></div>';
                noHistoryMessage.classList.add('hidden');

                const historyRef = collection(db, 'users', user.uid, 'history');
                const q = query(historyRef, orderBy('timestamp', 'desc'), limit(20));
                
                try {
                    const snapshot = await getDocs(q);
                    historyList.innerHTML = '';
                    if (snapshot.empty) {
                        noHistoryMessage.classList.remove('hidden');
                    } else {
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const li = document.createElement('li');
                            li.className = 'p-3 border-b';
                            li.innerHTML = `
                                <p class="font-semibold">${data.name}</p>
                                <p class="text-sm text-gray-500">Searched on: ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                            `;
                            li.addEventListener('click', () => {
                                closeAllModals();
                                if(window.location.hash !== '#map') window.location.hash = '#map';
                                setTimeout(() => {
                                    map.setView([data.lat, data.lng], 13);
                                    fetchAllDataForLocation(data.lat, data.lng);
                                }, 100);
                            });
                            historyList.appendChild(li);
                        });
                    }
                } catch (error) {
                    console.error("Error getting history: ", error);
                    historyList.innerHTML = `<p class="text-red-500 text-center">Could not load history.</p>`;
                }
            };


            // --- MAP APPLICATION LOGIC (INITIALIZED ON DEMAND) ---
            function initializeMapApp() {
                // API KEYS
                const WAQI_API_KEY = "928a43b09b68edba7abf27fda1fa9a9a754fd8c0";
                const OPENWEATHER_API_KEY = "8e8cc4c4a2a0e8af0a9a96d4d0277b58";
                
                let currentCityData = {}; 

                // Inject map UI elements
                mapContainer.innerHTML = `
                    <div id="map"></div>
                    <button id="locate-btn" class="absolute bottom-4 left-4 z-[1000] bg-white p-3 rounded-full shadow-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Find my location">
                        <svg id="locate-icon" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="currentColor" class="text-gray-600"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
                    </button>
                    <div id="data-panel" class="absolute top-[140px] sm:top-24 left-2 right-2 sm:left-auto sm:right-4 sm:w-80 z-[1000] bg-white/90 backdrop-blur-sm p-4 rounded-lg shadow-lg hidden">
                        <div id="loading" class="flex justify-center items-center h-48"><div class="loader"></div></div>
                        <div id="data-content" class="hidden">
                            <button id="close-panel-btn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 z-10 p-1 rounded-full hover:bg-gray-100"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button>
                            <h2 id="city-name" class="text-xl font-bold text-gray-800 pr-6">...</h2>
                            <p id="update-time" class="text-xs text-gray-500">...</p>
                            <hr class="my-3">
                            <div class="text-center">
                                <p class="text-sm text-gray-600" data-lang-key="dataPanelAQI">Air Quality Index (AQI)</p>
                                <div id="aqi-value" class="text-6xl font-bold my-2 text-gray-700">--</div>
                                <div id="aqi-status" class="px-3 py-1 text-white rounded-full text-sm inline-block bg-gray-400">...</div>
                            </div>
                            <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                                <div><p class="text-xs text-gray-500" data-lang-key="dataPanelTemp">Temp</p><p id="temp-value" class="font-bold text-lg">--°C</p></div>
                                <div><p class="text-xs text-gray-500" data-lang-key="dataPanelHumidity">Humidity</p><p id="humidity-value" class="font-bold text-lg">--%</p></div>
                                <div><p class="text-xs text-gray-500" data-lang-key="dataPanelWind">Wind</p><p id="wind-value" class="font-bold text-lg">-- km/h</p></div>
                            </div>
                            <div class="mt-4 bg-gray-100 p-2 rounded-lg">
                                <h4 class="font-bold text-sm" data-lang-key="dataPanelHealthAdvice">Health Advice:</h4>
                                <p id="forecast-text" class="text-xs text-gray-700">Analyzing data...</p>
                            </div>
                        </div>
                    </div>
                `;

                // Map UI element references
                const dataPanel = document.getElementById('data-panel');
                const loadingDiv = document.getElementById('loading');
                const dataContentDiv = document.getElementById('data-content');
                const cityNameEl = document.getElementById('city-name');
                const updateTimeEl = document.getElementById('update-time');
                const aqiValueEl = document.getElementById('aqi-value');
                const aqiStatusEl = document.getElementById('aqi-status');
                const tempValueEl = document.getElementById('temp-value');
                const humidityValueEl = document.getElementById('humidity-value');
                const windValueEl = document.getElementById('wind-value');
                const forecastTextEl = document.getElementById('forecast-text');
                
                // Map Initialization
                map = L.map('map').setView([26.8206, 30.8025], 6); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                let marker = L.marker([26.8206, 30.8025], { opacity: 0 }).addTo(map);

                const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                L.Control.geocoder({
                    defaultMarkGeocode: false,
                    placeholder: translations[currentLang].searchPlaceholder,
                    geocoder: L.Control.Geocoder.nominatim({
                        geocodingQueryParams: { "accept-language": "ar,en" } 
                    })
                }).on('markgeocode', function(e) {
                    const { center, name } = e.geocode;
                    map.setView(center, 13);
                    saveSearchToHistory({name: name, lat: center.lat, lng: center.lng});
                    marker.setLatLng(center).setOpacity(1);
                    fetchAllDataForLocation(center.lat, center.lng);
                }).addTo(map);

                // --- DATA FETCHING & UI LOGIC (FIXED) ---
                const fetchAllDataForLocation = async (lat, lng) => {
                    dataPanel.classList.remove('hidden');
                    loadingDiv.classList.remove('hidden');
                    dataContentDiv.classList.add('hidden');
                    
                    const results = await Promise.allSettled([
                        fetchAqiData(lat, lng), 
                        fetchWeatherData(lat, lng)
                    ]);

                    const aqiResult = results[0];
                    const weatherResult = results[1];

                    const aqiData = aqiResult.status === 'fulfilled' ? aqiResult.value : null;
                    const weatherData = weatherResult.status === 'fulfilled' ? weatherResult.value : null;

                    if (aqiResult.status === 'rejected') console.error("AQI Fetch Error:", aqiResult.reason);
                    if (weatherResult.status === 'rejected') console.error("Weather Fetch Error:", weatherResult.reason);
                    
                    if (!aqiData && !weatherData) {
                        const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                        handleError(translations[currentLang].fetchError);
                    } else {
                        updateUIPanel({ aqiData, weatherData, lat, lng });
                    }
                };
                
                const fetchAqiData = async (lat, lng) => {
                    const url = `https://api.waqi.info/feed/geo:${lat};${lng}/?token=${WAQI_API_KEY}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch AQI data.');
                    const data = await response.json();
                    if (data.status !== "ok") throw new Error(data.data || 'No station found.');
                    return data.data;
                };

                const fetchWeatherData = async (lat, lng) => {
                    const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${OPENWEATHER_API_KEY}&units=metric`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Could not fetch weather data.');
                    return await response.json();
                };
                
                const getAqiStatus = (aqi) => {
                     if (aqi <= 50) return { statusKey: "aqiStatusGood", adviceKey: "aqiAdviceGood", color: "#22c55e" };
                     if (aqi <= 100) return { statusKey: "aqiStatusModerate", adviceKey: "aqiAdviceModerate", color: "#facc15" };
                     if (aqi <= 150) return { statusKey: "aqiStatusUnhealthySensitive", adviceKey: "aqiAdviceUnhealthySensitive", color: "#f97316" };
                     if (aqi <= 200) return { statusKey: "aqiStatusUnhealthy", adviceKey: "aqiAdviceUnhealthy", color: "#ef4444" };
                     if (aqi <= 300) return { statusKey: "aqiStatusVeryUnhealthy", adviceKey: "aqiAdviceVeryUnhealthy", color: "#a855f7" };
                     return { statusKey: "aqiStatusHazardous", adviceKey: "aqiAdviceHazardous", color: "#7f1d1d" };
                };

                const updateUIPanel = ({ aqiData, weatherData, lat, lng }) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    if (aqiData && aqiData.city) {
                        currentCityData = { name: aqiData.city.name, lat, lng };
                        cityNameEl.textContent = aqiData.city.name;
                        updateTimeEl.textContent = `Updated: ${new Date(aqiData.time.s).toLocaleString()}`;
                        aqiValueEl.textContent = aqiData.aqi;
                        const { statusKey, adviceKey, color } = getAqiStatus(aqiData.aqi);
                        aqiStatusEl.textContent = translations[currentLang][statusKey];
                        aqiStatusEl.style.backgroundColor = color;
                        forecastTextEl.textContent = translations[currentLang][adviceKey];
                    } else {
                        handleError(translations[currentLang].aqiError);
                    }

                    if (weatherData && weatherData.main) {
                        tempValueEl.textContent = `${Math.round(weatherData.main.temp)}°C`;
                        humidityValueEl.textContent = `${weatherData.main.humidity}%`;
                        windValueEl.textContent = `${Math.round(weatherData.wind.speed * 3.6)} km/h`;
                    }
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                    setLanguage(currentLang);
                };
                
                const handleError = (message) => {
                    const currentLang = localStorage.getItem('preferredLanguage') || 'en';
                    cityNameEl.textContent = translations[currentLang].errorTitle;
                    updateTimeEl.textContent = "";
                    aqiValueEl.textContent = "N/A";
                    aqiStatusEl.textContent = translations[currentLang].aqiStatusNoData;
                    aqiStatusEl.style.backgroundColor = "#9ca3af";
                    forecastTextEl.textContent = message;
                    loadingDiv.classList.add('hidden');
                    dataContentDiv.classList.remove('hidden');
                };

                map.on('click', function(e) {
                    const { lat, lng } = e.latlng;
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(lat, lng);
                    const geocoder = L.Control.Geocoder.nominatim();
                    geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), (results) => {
                        if (results && results.length > 0) {
                            saveSearchToHistory({ name: results[0].name, lat, lng });
                        }
                    });
                });
                
                document.getElementById('close-panel-btn').addEventListener('click', () => dataPanel.classList.add('hidden'));
                document.getElementById('locate-btn').addEventListener('click', () => map.locate({setView: true, maxZoom: 13}));
                map.on('locationfound', (e) => {
                    marker.setLatLng(e.latlng).setOpacity(1);
                    fetchAllDataForLocation(e.latlng.lat, e.latlng.lng);
                });
                map.on('locationerror', (e) => console.error("Location Error: ", e.message));
            }
        });
    </script>
</body>
</html>
